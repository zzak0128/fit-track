@page "/routines"
@using FitTrack.Components.Pages.Activities
@using FitTrack.Data
@using FitTrack.Data.DTOs.Routines
@using FitTrack.Extensions
@using FitTrack.Services.Routines
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject IRoutineService RoutineService
@inject IDialogService DialogService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Routines</PageTitle>

@if (!RoutineList.Any())
{
    <MudPaper Elevation="2" Class="pa-3">
        <MudText Typo="Typo.h2" Color="Color.Primary">No routines are available</MudText>
        <MudText Typo="Typo.h6">Click the button below to create your first routine!</MudText>
    </MudPaper>
}
else
{
    <PageHeaderTitle title="Routines"/>

    <MudTable T="BaseRoutineDto" Items="@RoutineList" Hover Striped OnRowClick="@OnRowClickHandler">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Description</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Description">@context.Description</MudTd>
            <MudTd Class="d-flex justify-end">
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => DeleteRoutineAsync(context.Id)"/>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

<MudStack Row Justify="Justify.FlexEnd" AlignItems="AlignItems.End" Spacing="1" Style="position:fixed; bottom:25px; right:25px" >
    <MudFab Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="CreateRoutineAsync" title="Add a new Routine" />
    <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Leaderboard" title="Log a Workout" OnClick="StartActivityAsync" />
</MudStack>

@code {
    public List<BaseRoutineDto> RoutineList { get; set; } = [];
    public ApplicationUser? CurrentUser { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        CurrentUser = await UserManager.GetUserAsync(authState.User);

        if (CurrentUser is not null)
        {
            RoutineList = await RoutineService.GetBaseRoutinesAsync(CurrentUser);
        }
    }

    private void OnRowClickHandler(TableRowClickEventArgs<BaseRoutineDto> args)
    {
        var routineId = args.Item.Id;
        var uri = $"/routines/detail/{routineId}";
        Navigation.NavigateTo(uri);
    }

    private async Task CreateRoutineAsync()
    {
        var dialogParams = new DialogParameters<CreateRoutineDialog>
        {
            {x  => x.ApplicationUser, CurrentUser }
        };

        var dialogOptions = new DialogOptions
        {
            FullWidth = false
        };

        var createDialog = await DialogService.ShowAsync<CreateRoutineDialog>("Create a new Routine!", dialogParams, dialogOptions);
        var result = await createDialog.Result;
        if (!result.Canceled)
        {
            bool success = await createDialog.GetReturnValueAsync<bool>();
            if (success)
            {
                createDialog.Close();
                RoutineList = await RoutineService.GetBaseRoutinesAsync(CurrentUser!);
            }
            else
            {
                Snackbar.Add("Failed to Save the new Routine", Severity.Error);
            }
        }
    }

    private async Task StartActivityAsync()
    {
        var dialogParams = new DialogParameters<CreateActivityDialog>
        {
            {x  => x.ApplicationUser, CurrentUser }
        };

        var createDialog = await DialogService.ShowAsync<CreateActivityDialog>("Create a new Activity!", dialogParams);
        var result = await createDialog.Result;
        if (!result.Canceled)
        {
            int newActivityId = await createDialog.GetReturnValueAsync<int>();
            if (newActivityId > 0)
            {
                createDialog.Close();
                Navigation.NavigateTo($"/activity/start/{newActivityId}", true);
            }
            else
            {
                Snackbar.Add("Failed to start the new workout", Severity.Error);
            }
        }
    }

    private async Task DeleteRoutineAsync(int routineId)
    {
        if(await DialogService.ConfirmDelete())
        try
        {
            await RoutineService.DeleteRoutineAsync(routineId);
        }
        catch
        {
            Snackbar.Add("Failed to delete the routine", Severity.Error);
        }

        RoutineList = await RoutineService.GetBaseRoutinesAsync(CurrentUser);
    }
}
