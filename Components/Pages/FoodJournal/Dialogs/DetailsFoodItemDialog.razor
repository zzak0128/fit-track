@using FitTrack.Data.DTOs.FoodJournal
@using FitTrack.Services.FoodJournal
@inject IFoodService FoodService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        @MudDialog.Title
    </TitleContent>
    <DialogContent>
        <FoodItemDetailsItem FoodItem="FoodItem" />
    </DialogContent>
    <DialogActions>
        <MudStack Row>
            <MudMenu Color="Color.Secondary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.MoreHoriz">
                <MudMenuItem Label="Edit" Icon="@Icons.Material.Filled.Edit" OnClick="EditFoodItemAsync"/>
                <MudMenuItem Label="Delete" Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" OnClick="DeleteFoodItemAsync" />
            </MudMenu>
            <MudButton Color="Color.Primary" OnClick="Close" Variant="Variant.Filled">OK</MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = null!;
    private MudForm form { get; set; } = null!;

    [Parameter]
    public FoodItemDto FoodItem { get; set; } = null!;

    private void Close() => MudDialog.Close(DialogResult.Ok(true));

    private async Task DeleteFoodItemAsync()
    {
        try
        {
            await FoodService.DeleteFoodItemAsync(FoodItem.Id);
            MudDialog.Close(true);
        }
        catch (Exception)
        {
            MudDialog.Close(false);
        }
    }

    private async Task EditFoodItemAsync()
    {
        var parameters = new DialogParameters<EditFoodItemDialog>
        {
            { x => x.EditFoodItem, FoodItem }
        };

        var editDialog = await DialogService.ShowAsync<EditFoodItemDialog>("Edit Food Item", parameters);
        var result = await editDialog.Result;
        if (!result!.Canceled)
        {
            FoodItemDto? updatedFoodItem = await editDialog.GetReturnValueAsync<FoodItemDto>();
            if (updatedFoodItem is not null)
            {
                FoodItem = updatedFoodItem;
            }
            else
            {
                Snackbar.Add("Failed to update the Food Item", Severity.Error);
            }
        }
    }
}

