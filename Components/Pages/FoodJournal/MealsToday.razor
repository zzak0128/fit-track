@page "/FoodJournal/Today"
@using FitTrack.Data
@using FitTrack.Data.DTOs.FoodJournal
@using FitTrack.Data.Models.FoodJournal
@using FitTrack.Services.FoodJournal
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IFoodService FoodService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@attribute [Authorize]

<PageTitle>Today's Meals</PageTitle>
<PageHeaderTitle Title="Today's Meals" ActionMenu="_headerMenu">
    <ChildContent>
        <MudSpacer />
            <MudStack Row AlignItems="AlignItems.Center">
                <MudIconButton Icon="@Icons.Material.Rounded.ArrowCircleLeft" OnClick="PreviousDayAsync" />
                <MudButton Variant="Variant.Text" Color="Color.Info" OnClick="CurrentDayAsync">@_currentDate.ToShortDateString()</MudButton>
                <MudIconButton Icon="@Icons.Material.Rounded.ArrowCircleRight" OnClick="NextDayAsync" Disabled="@(_currentDate.Date >= DateTime.Now.Date)" />
            </MudStack>
            <MudSpacer />
    </ChildContent>
</PageHeaderTitle>

<AuthorizeView>
    <Authorized>
        <MudMenu @ref="_headerMenu" PositionAtCursor>
            <ChildContent>
                <MudMenuItem Icon="@Icons.Material.Outlined.Add" OnClick="CreateMealAsync">Add a new Meal</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </Authorized>
</AuthorizeView>

<MudExpansionPanels MultiExpansion="true">
    @foreach (var item in TodaysMeals)
    {
        <MudExpansionPanel Expanded>
            <TitleContent>
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6" Color="Color.Primary">@item.MealType.ToString()</MudText>
                    <MudStack row Class="pr-3">
                        <MudProgressCircular Value="@(CalculateGoals(item.FoodServings, "carbs"))" Color="Color.Primary">
                            <ChildContent>
                                <MudText>C</MudText>
                            </ChildContent>
                        </MudProgressCircular>
                        <MudProgressCircular Value="@(CalculateGoals(item.FoodServings, "fat"))" Color="Color.Secondary">
                            <ChildContent>
                                <MudText>F</MudText>
                            </ChildContent>
                        </MudProgressCircular>
                        <MudProgressCircular Value="@(CalculateGoals(item.FoodServings, "protein"))" Color="Color.Tertiary">
                            <ChildContent>
                                <MudText>P</MudText>
                            </ChildContent>
                        </MudProgressCircular>
                    </MudStack>
                    <MudIconButton Icon="@Icons.Material.Rounded.Add" Color="Color.Primary" Class="rounded-circle" DropShadow="false" Variant="Variant.Filled" OnClick="() => AddToMealAsync(item)" />
                </MudStack>
            </TitleContent>
            <ChildContent>
                <MudTable Items="item.FoodServings" Breakpoint="Breakpoint.None" Elevation="0">
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Servings</MudTh>
                        <MudTh>Calories</MudTh>
                        <MudTh>Carbs</MudTh>
                        <MudTh>Fats</MudTh>
                        <MudTh>Protein</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.FoodItem.Name</MudTd>
                        <MudTd>@context.Servings</MudTd>
                        <MudTd>@(context.FoodItem.Calories* context.Servings)</MudTd>
                        <MudTd>@(context.FoodItem.Carbs* context.Servings)</MudTd>
                        <MudTd>@(context.FoodItem.Fats* context.Servings)</MudTd>
                        <MudTd>@(context.FoodItem.Proteins* context.Servings)</MudTd>
                        <MudTd Class="d-flex justify-end">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => DeleteServingAsync(context.Id)" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </ChildContent>
        </MudExpansionPanel>
    }
</MudExpansionPanels>

    @code {
    private int _calorieGoal = 2000;
    private int _proteinGoal = 90;
    private int _fatGoal = 70;
    private int _carbGoal = 250;

    private MudMenu? _headerMenu;
    public DateTime _currentDate { get; set; } = DateTime.Now;

    public List<MealDto> TodaysMeals { get; set; } = [];
    public ApplicationUser? CurrentUser { get; set; }

    protected async override Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        CurrentUser = await UserManager.GetUserAsync(authState.User);

        if (CurrentUser is not null)
        {
            TodaysMeals = await FoodService.GetMealsByDateAsync(_currentDate, CurrentUser);
        }
    }

    private int CalculateGoals(List<MealFoodServingDto> foodsToCalc, string goalToCalc)
    {
        // Logic to calculate goals can be added here
        switch (goalToCalc)
        {
            case "carbs":
                return (int)foodsToCalc.Sum(x => x.FoodItem.Carbs * x.Servings);
            case "protein":
                return (int)foodsToCalc.Sum(x => x.FoodItem.Proteins * x.Servings);
            case "fat":
                return (int)foodsToCalc.Sum(x => x.FoodItem.Fats * x.Servings);
            default:
                return 0;
        }
    }

    private async void CreateMealAsync()
    {
        // Navigation to create food item page can be added here
    }

    private async Task AddToMealAsync(MealDto meal)
    {
        var addFoodItemDialog = await DialogService.ShowAsync<AddFoodToMealDialog>("Select a food to add.");
        var result = await addFoodItemDialog.Result;
        if (!result!.Canceled)
        {
            MealFoodServingDto? selectedServing = await addFoodItemDialog.GetReturnValueAsync<MealFoodServingDto>();
            if (selectedServing is not null)
            {
                meal.FoodServings.Add(selectedServing);
                try
                {
                    await FoodService.AddFoodToMealAsync(meal.Id, selectedServing);
                }
                catch (Exception)
                {
                    Snackbar.Add("Failed to add to this meal", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Failed to add to this meal", Severity.Error);
            }
        }
    }

    private async Task DeleteServingAsync(int id)
    {
        try
        {
            await FoodService.DeleteMealFoodServingAsync(id);
            TodaysMeals = await FoodService.GetMealsByDateAsync(_currentDate, CurrentUser!);
        }
        catch (Exception)
        {
            Snackbar.Add($"Failed to delete this meal serving.", Severity.Error);
            throw;
        }
    }

    private async Task CurrentDayAsync()
    {
        _currentDate = DateTime.Now;
        TodaysMeals = await FoodService.GetMealsByDateAsync(_currentDate, CurrentUser!);
    }

    private async Task PreviousDayAsync()
    {
        _currentDate = _currentDate.AddDays(-1);
        TodaysMeals = await FoodService.GetMealsByDateAsync(_currentDate, CurrentUser!);
    }

    private async Task NextDayAsync()
    {
        if (_currentDate.Date >= DateTime.Now.Date)
        {
            return;
        }

        _currentDate = _currentDate.AddDays(1);
        TodaysMeals = await FoodService.GetMealsByDateAsync(_currentDate, CurrentUser!);
    }
}
