@page "/foods"
@inject IFoodService FoodService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@using FitTrack.Data.DTOs.FoodJournal
@using FitTrack.Services.FoodJournal
@using System.Threading.Tasks

<PageTitle>Food List</PageTitle>
<PageHeaderTitle Title="Food List" ActionMenu="_headerMenu" />

@if (!AllFoodItems.Any())
{
    <MudPaper Elevation="2" Class="pa-3">
        <MudText Typo="Typo.h2" Color="Color.Primary">No food have been added.</MudText>
        <MudText Typo="Typo.h6">Click the button below to add your first food item!</MudText>
    </MudPaper>
}
else
{
    <MudStack Spacing="6">
        <MudStack Spacing="2" Justify="Justify.FlexStart">
            <MudTable T="FoodItemDto" Items="AllFoodItems" Breakpoint="Breakpoint.Xs" Striped Hover Filter="new Func<FoodItemDto, bool>(FilterFood)" OnRowClick="OpenDetails">
                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Food</MudTh>
                    <MudTh>Serving</MudTh>
                    <MudTh>Calories</MudTh>
                    <MudTh>Carbs</MudTh>
                    <MudTh>Fats</MudTh>
                    <MudTh>Protein</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Food">@context.Name</MudTd>
                    <MudTd DataLabel="Serving">@context.ServingSize @context.Units</MudTd>
                    <MudTd DataLabel="Calories">@context.Calories</MudTd>
                    <MudTd DataLabel="Carbs">@context.Carbs</MudTd>
                    <MudTd DataLabel="Fats">@context.Fats</MudTd>
                    <MudTd DataLabel="Protein">@context.Proteins</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudStack>
    </MudStack>
}

<AuthorizeView>
    <Authorized>
        <MudMenu @ref="_headerMenu" PositionAtCursor>
            <ChildContent>
                <MudMenuItem Icon="@Icons.Material.Outlined.Add" OnClick="CreateFoodItemAsync">Add a new Food</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </Authorized>
</AuthorizeView>

@if (_isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mb-4 mt-4" />
}

<MudStack Row Spacing="6" Style="position:fixed; bottom:25px; right:25px;">
    <MudScrollToTop>
        <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.KeyboardArrowUp" />
    </MudScrollToTop>
</MudStack>

@code {
    private string _searchString = "";
    private bool _isLoading = false;

    private List<FoodItemDto> AllFoodItems { get; set; } = [];

    private MudMenu _headerMenu = null!;

    protected async override Task OnInitializedAsync()
    {
        AllFoodItems = await FoodService.GetAllFoodAsync();
    }

    private async Task CreateFoodItemAsync()
    {
        var createDialog = await DialogService.ShowAsync<CreateFoodItemDialog>("Create a new Food Item!");
        var result = await createDialog.Result;
        if (!result!.Canceled)
        {
            bool success = await createDialog.GetReturnValueAsync<bool>();
            if (success)
            {
                createDialog.Close();
                AllFoodItems = await FoodService.GetAllFoodAsync();
            }
            else
            {
                Snackbar.Add("Failed to save the Food Item", Severity.Error);
            }
        }
    }

    private bool FilterFood(FoodItemDto element) => FilterFood(element, _searchString);

    private bool FilterFood(FoodItemDto element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private async Task OpenDetails(TableRowClickEventArgs<FoodItemDto> args)
    {
        var foodItem = args.Item;

        var dialogParams = new DialogParameters<DetailsFoodItemDialog>()
        {
            {x => x.FoodItem, foodItem }
        };

        var detailDialog = await DialogService.ShowAsync<DetailsFoodItemDialog>($"{foodItem.Name} Details", dialogParams);
        var result = await detailDialog.Result;
        if (!result!.Canceled)
        {
            bool success = await detailDialog.GetReturnValueAsync<bool>();
            if (success)
            {
                AllFoodItems = await FoodService.GetAllFoodAsync();
            }
            else
            {
                Snackbar.Add("Failed to delete the given food item", Severity.Error);
            }
        }
    }
}
